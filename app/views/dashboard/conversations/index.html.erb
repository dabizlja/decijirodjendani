<%= render "dashboard/dashboard/header" %>

<!-- Conversations Layout -->
<div class="max-w-6xl mx-auto px-6 py-8">
  <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
    <div class="flex h-[600px]">
      <!-- Conversations List -->
      <div class="w-1/3 border-r border-gray-200 flex flex-col">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
            游눫 Poruke
          </h2>
          <p class="text-sm text-gray-500">Konverzacije sa roditeljima</p>
        </div>

        <!-- Conversations -->
        <div class="flex-1 overflow-y-auto">
          <% if @conversations.any? %>
            <% @conversations.each do |conversation| %>
              <% last_message = conversation.messages.order(:created_at).last %>
              <% is_selected = @selected_conversation&.id == conversation.id %>
              <%= link_to dashboard_conversations_path(conversation_id: conversation.id),
                  class: "block p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors #{'bg-purple-50' if is_selected}" do %>
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0">
                    <% avatar_url = conversation.customer.avatar_url.presence %>
                    <% initials = conversation.customer.full_name.to_s.strip.first&.upcase || "U" %>
                    <% if avatar_url.present? %>
                      <img src="<%= avatar_url %>"
                           alt="<%= conversation.customer.full_name %>"
                           class="h-10 w-10 rounded-full object-cover" />
                    <% else %>
                      <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-purple-500 to-pink-500 text-sm font-semibold text-white">
                        <%= initials %>
                      </div>
                    <% end %>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                      <p class="text-sm font-semibold text-gray-900 truncate">
                        <%= conversation.customer.full_name %>
                      </p>
                      <% if last_message %>
                        <p class="text-xs text-gray-500">
                          <%= time_ago_in_words(last_message.created_at) %>
                        </p>
                      <% end %>
                    </div>
                    <p class="text-xs text-gray-600 mb-1">
                      Biznis: <%= conversation.business.display_name %>
                    </p>
                    <% if last_message %>
                      <p class="text-sm text-gray-700 truncate">
                        <%= truncate(last_message.body, length: 60) %>
                      </p>
                    <% else %>
                      <p class="text-sm text-gray-500 italic">Nema poruka</p>
                    <% end %>
                    <% unread_count = conversation.unread_messages_for(current_user).count %>
                    <% if unread_count.positive? %>
                      <span class="inline-block mt-1 px-2 py-1 bg-red-500 text-white text-xs rounded-full">
                        <%= unread_count %>
                      </span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <div class="p-6 text-center text-gray-500">
              <div class="text-4xl mb-4">游눫</div>
              <p>Nemate poruke jo코 uvek</p>
              <p class="text-sm">Kada roditelji po코alju poruku, vide캖ete je ovde</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Messages Area -->
      <div class="flex-1 flex flex-col">
        <% if @selected_conversation %>
          <!-- Chat Header -->
          <div class="p-6 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center gap-3">
              <% avatar_url = @selected_conversation.customer.avatar_url.presence %>
              <% initials = @selected_conversation.customer.full_name.to_s.strip.first&.upcase || "U" %>
              <% if avatar_url.present? %>
                <img src="<%= avatar_url %>"
                     alt="<%= @selected_conversation.customer.full_name %>"
                     class="h-12 w-12 rounded-full object-cover" />
              <% else %>
                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-br from-purple-500 to-pink-500 text-lg font-semibold text-white">
                  <%= initials %>
                </div>
              <% end %>
              <div>
                <h3 class="font-semibold text-gray-900">
                  <%= @selected_conversation.customer.full_name %>
                </h3>
                <p class="text-sm text-gray-600">
                  Pita o: <%= @selected_conversation.business.display_name %>
                </p>
              </div>
            </div>
          </div>

          <!-- Messages -->
          <div class="flex-1 p-6 overflow-y-auto"
               data-conversation-subscription="<%= @selected_conversation.id %>"
               data-current-user-id="<%= current_user.id %>">
            <div class="space-y-4" data-conversation-messages>
              <% @selected_conversation.messages.includes(:user).order(:created_at).each do |message| %>
                <% is_own_message = message.user == current_user %>
                <div class="flex <%= is_own_message ? 'justify-end' : 'justify-start' %>">
                  <div class="max-w-xl rounded-2xl px-4 py-3 shadow-sm <%= is_own_message ? 'bg-purple-600 text-white' : 'bg-white text-gray-900 border border-gray-100' %>">
                    <p class="text-sm whitespace-pre-wrap"><%= message.body %></p>
                    <p class="text-xs mt-2 <%= is_own_message ? 'text-purple-100' : 'text-gray-500' %>">
                      <%= l(message.created_at, format: "%d.%m.%Y u %H:%M") %>
                    </p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Message Form -->
          <div class="p-6 border-t border-gray-200 bg-gray-50">
            <%= form_with model: [@selected_conversation, @new_message],
                          url: dashboard_conversation_messages_path(@selected_conversation),
                          local: true,
                          class: "flex gap-4",
                          data: { conversation_form: true } do |form| %>
              <%= form.text_area :body,
                  rows: 2,
                  class: "flex-1 rounded-2xl border-2 border-gray-200 px-4 py-3 focus:border-purple-500 focus:outline-none text-gray-800 resize-none",
                  placeholder: "Napi코ite poruku..." %>
              <%= form.submit "Po코alji",
                  class: "px-6 py-3 bg-purple-600 text-white rounded-2xl font-medium hover:bg-purple-700 transition-colors" %>
            <% end %>
          </div>
        <% else %>
          <!-- No Conversation Selected -->
          <div class="flex-1 flex items-center justify-center text-gray-500">
            <div class="text-center">
              <div class="text-6xl mb-4">游눫</div>
              <h3 class="text-xl font-semibold mb-2">Izaberite konverzaciju</h3>
              <p>Kliknite na konverzaciju da biste po캜eli da 캜itate poruke</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>